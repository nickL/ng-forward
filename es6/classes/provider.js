import { bundleStore, providerStore } from '../writers';
import Module from './module';
import { Inject } from '../decorators/inject';
import { getInjectableNameWithJitCreation } from '../util/get-injectable-name';
import { Providers } from '../decorators/providers';
import { INJECTABLE } from '../decorators/injectable';
const TYPE = 'provider';
export class Provider {
    constructor(token, { useClass, useValue, useConstant, useFactory, deps }) {
        this.isProvider = true;
        this._dependencies = [];
        try {
            this.token = getInjectableNameWithJitCreation(token);
        }
        catch (e) {
            throw new Error(`new Provider() Error: Invalid token ${token}`);
        }
        Object.assign(this, { useClass, useValue, useConstant, useFactory });
        if (!useClass && !useValue && !useConstant && !useFactory) {
            throw new Error(`new Provider(${token}) Error: No usage provided (i.e. useClass, useValue, useConstant, useFactory)`);
        }
        if (deps) {
            Inject(...deps)(this.useFactory);
            Providers(...deps.filter(d => typeof d !== 'string'))(this.useFactory, `while analyzing Provider '${this.token}' useFactory deps`);
            this._dependencies = bundleStore.get('$inject', this.useFactory);
        }
        providerStore.set('name', this.token, this);
        providerStore.set('type', TYPE, this);
    }
    get type() {
        if (this._type)
            return this._type;
        this._type = Object.keys(this).find((k) => k.startsWith('use') && this[k] !== undefined);
        return this._type;
    }
    get dependencies() {
        return this._dependencies;
    }
}
Module.addProvider(TYPE, (provider, name, injects, ngModule) => {
    switch (provider.type) {
        case 'useValue':
            ngModule.value(provider.token, provider.useValue);
            break;
        case 'useConstant':
            ngModule.constant(provider.token, provider.useConstant);
            break;
        case 'useClass':
            injects = bundleStore.get('$inject', provider.useClass) || [];
            Module.getParser(INJECTABLE)(provider.useClass, provider.token, injects, ngModule);
            break;
        case 'useFactory':
            ngModule.factory(provider.token, [...provider.dependencies, provider.useFactory]);
            break;
        default:
            break;
    }
});
export const provide = (token, { useClass, useValue, useConstant, useFactory, deps }) => {
    return new Provider(token, { useClass, useValue, useConstant, useFactory, deps });
};

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jbGFzc2VzL3Byb3ZpZGVyLnRzIl0sIm5hbWVzIjpbIlByb3ZpZGVyIiwiUHJvdmlkZXIuY29uc3RydWN0b3IiLCJQcm92aWRlci50eXBlIiwiUHJvdmlkZXIuZGVwZW5kZW5jaWVzIl0sIm1hcHBpbmdzIjoiT0FBTyxFQUFFLFdBQVcsRUFBRSxhQUFhLEVBQUUsTUFBTSxZQUFZO09BQ2hELE1BQU0sTUFBTSxVQUFVO09BQ3RCLEVBQUMsTUFBTSxFQUFDLE1BQU0sc0JBQXNCO09BQ3BDLEVBQUMsZ0NBQWdDLEVBQUMsTUFBTSw2QkFBNkI7T0FDckUsRUFBQyxTQUFTLEVBQUMsTUFBTSx5QkFBeUI7T0FDMUMsRUFBQyxVQUFVLEVBQUMsTUFBTSwwQkFBMEI7QUFHbkQsTUFBTSxJQUFJLEdBQUcsVUFBVSxDQUFDO0FBS3hCO0lBVUVBLFlBQVlBLEtBQWtDQSxFQUM1Q0EsRUFDRUEsUUFBUUEsRUFDUkEsUUFBUUEsRUFDUkEsV0FBV0EsRUFDWEEsVUFBVUEsRUFDVkEsSUFBSUEsRUFRTEE7UUF2QklDLGVBQVVBLEdBQUdBLElBQUlBLENBQUNBO1FBTWpCQSxrQkFBYUEsR0FBYUEsRUFBRUEsQ0FBQ0E7UUFtQm5DQSxJQUFJQSxDQUFDQTtZQUFDQSxJQUFJQSxDQUFDQSxLQUFLQSxHQUFHQSxnQ0FBZ0NBLENBQUNBLEtBQUtBLENBQUNBLENBQUNBO1FBQUNBLENBQzVEQTtRQUFBQSxLQUFLQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQTtZQUFDQSxNQUFNQSxJQUFJQSxLQUFLQSxDQUFDQSx1Q0FBdUNBLEtBQUtBLEVBQUVBLENBQUNBLENBQUNBO1FBQUNBLENBQUNBO1FBRTlFQSxNQUFNQSxDQUFDQSxNQUFNQSxDQUFDQSxJQUFJQSxFQUFFQSxFQUFDQSxRQUFRQSxFQUFFQSxRQUFRQSxFQUFFQSxXQUFXQSxFQUFFQSxVQUFVQSxFQUFDQSxDQUFDQSxDQUFDQTtRQUVuRUEsRUFBRUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsUUFBUUEsSUFB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LFFBQVEsQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDO1lBQ2xGLEtBQUssQ0FBQztRQUNWO1lBQ0ksS0FBSyxDQUFDO0lBQ1osQ0FBQztBQUNILENBQUMsQ0FBQyxDQUFDO0FBT0gsYUFBYSxPQUFPLEdBQUcsQ0FBQyxLQUFrQyxFQUN0RCxFQUNFLFFBQVEsRUFDUixRQUFRLEVBQ1IsV0FBVyxFQUNYLFVBQVUsRUFDVixJQUFJLEVBUUw7SUFFSCxNQUFNLENBQUMsSUFBSSxRQUFRLENBQUMsS0FBSyxFQUFFLEVBQUMsUUFBUSxFQUFFLFFBQVEsRUFBRSxXQUFXLEVBQUUsVUFBVSxFQUFFLElBQUksRUFBQyxDQUFDLENBQUM7QUFDbEYsQ0FBQyxDQUFDIiwiZmlsZSI6ImxpYi9jbGFzc2VzL3Byb3ZpZGVyLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgYnVuZGxlU3RvcmUsIHByb3ZpZGVyU3RvcmUgfSBmcm9tICcuLi93cml0ZXJzJztcbmltcG9ydCBNb2R1bGUgZnJvbSAnLi9tb2R1bGUnO1xuaW1wb3J0IHtJbmplY3R9IGZyb20gJy4uL2RlY29yYXRvcnMvaW5qZWN0JztcbmltcG9ydCB7Z2V0SW5qZWN0YWJsZU5hbWVXaXRoSml0Q3JlYXRpb259IGZyb20gJy4uL3V0aWwvZ2V0LWluamVjdGFibGUtbmFtZSc7XG5pbXBvcnQge1Byb3ZpZGVyc30gZnJvbSAnLi4vZGVjb3JhdG9ycy9wcm92aWRlcnMnO1xuaW1wb3J0IHtJTkpFQ1RBQkxFfSBmcm9tICcuLi9kZWNvcmF0b3JzL2luamVjdGFibGUnO1xuaW1wb3J0IHtPcGFxdWVUb2tlbn0gZnJvbSBcIi4vb3BhcXVlLXRva2VuXCI7XG5cbmNvbnN0IFRZUEUgPSAncHJvdmlkZXInO1xuXG4vKipcbiAqIEEgYmluZGluZyBmcm9tIGEgdG9rZW4gdG8gYSB2YWx1ZSAob25seSBvbmUgaW1wbGVtZW50ZWQgY3VycmVudGx5KSwgY2xhc3MsIGV4aXN0aW5nLCBvciBmYWN0b3J5XG4gKi9cbmV4cG9ydCBjbGFzcyBQcm92aWRlciB7XG4gIHB1YmxpYyBpc1Byb3ZpZGVyID0gdHJ1ZTtcbiAgcHVibGljIHRva2VuOiBhbnk7XG4gIHB1YmxpYyB1c2VDbGFzczogYW55O1xuICBwdWJsaWMgdXNlVmFsdWU6IGFueTtcbiAgcHVibGljIHVzZUNvbnN0YW50OiBhbnk7XG4gIHB1YmxpYyB1c2VGYWN0b3J5OiBhbnk7XG4gIHByaXZhdGUgX2RlcGVuZGVuY2llczogc3RyaW5nW10gPSBbXTtcbiAgcHJpdmF0ZSBfdHlwZTogc3RyaW5nO1xuXG4gIGNvbnN0cnVjdG9yKHRva2VuOiBzdHJpbmd8T3BhcXVlVG9rZW58RnVuY3Rpb24sXG4gICAge1xuICAgICAgdXNlQ2xhc3MsXG4gICAgICB1c2VWYWx1ZSwgXG4gICAgICB1c2VDb25zdGFudCwgXG4gICAgICB1c2VGYWN0b3J5LCBcbiAgICAgIGRlcHNcbiAgICB9IDogXG4gICAgeyBcbiAgICAgIHVzZUNsYXNzPzogYW55LCBcbiAgICAgIHVzZVZhbHVlPzogYW55LCBcbiAgICAgIHVzZUNvbnN0YW50PzogYW55LCBcbiAgICAgIHVzZUZhY3Rvcnk/OiBhbnksIFxuICAgICAgZGVwcz86IGFueVtdXG4gICAgfVxuICApIHtcbiAgICB0cnkgeyB0aGlzLnRva2VuID0gZ2V0SW5qZWN0YWJsZU5hbWVXaXRoSml0Q3JlYXRpb24odG9rZW4pOyB9XG4gICAgY2F0Y2ggKGUpIHsgdGhyb3cgbmV3IEVycm9yKGBuZXcgUHJvdmlkZXIoKSBFcnJvcjogSW52YWxpZCB0b2tlbiAke3Rva2VufWApOyB9XG5cbiAgICBPYmplY3QuYXNzaWduKHRoaXMsIHt1c2VDbGFzcywgdXNlVmFsdWUsIHVzZUNvbnN0YW50LCB1c2VGYWN0b3J5fSk7XG5cbiAgICBpZiAoIXVzZUNsYXNzICYmICF1c2VWYWx1ZSAmJiAhdXNlQ29uc3RhbnQgJiYgIXVzZUZhY3RvcnkpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgbmV3IFByb3ZpZGVyKCR7dG9rZW59KSBFcnJvcjogTm8gdXNhZ2UgcHJvdmlkZWQgKGkuZS4gdXNlQ2xhc3MsIHVzZVZhbHVlLCB1c2VDb25zdGFudCwgdXNlRmFjdG9yeSlgKVxuICAgIH1cblxuICAgIGlmIChkZXBzKSB7XG4gICAgICAvLyBTaW11bGF0ZSBoYXZpbmcgYm90aCBhbiBASW5qZWN0IGFuZCBwcm92aWRlOiBbXSBvbiB0aGUgZmFjdG9yeSBmdW5jdGlvblxuICAgICAgSW5qZWN0KC4uLmRlcHMpKHRoaXMudXNlRmFjdG9yeSk7XG4gICAgICBQcm92aWRlcnMoLi4uZGVwcy5maWx0ZXIoZCA9PiB0eXBlb2YgZCAhPT0gJ3N0cmluZycpKSh0aGlzLnVzZUZhY3RvcnksIGB3aGlsZSBhbmFseXppbmcgUHJvdmlkZXIgJyR7dGhpcy50b2tlbn0nIHVzZUZhY3RvcnkgZGVwc2ApO1xuICAgICAgdGhpcy5fZGVwZW5kZW5jaWVzID0gYnVuZGxlU3RvcmUuZ2V0KCckaW5qZWN0JywgdGhpcy51c2VGYWN0b3J5KTtcbiAgICB9XG5cbiAgICAvLyBTZXR1cCBwcm92aWRlciBpbmZvcm1hdGlvbiB1c2luZyB0aGUgcGFyc2VkIHNlbGVjdG9yXG4gICAgcHJvdmlkZXJTdG9yZS5zZXQoJ25hbWUnLCB0aGlzLnRva2VuLCB0aGlzKTtcbiAgICBwcm92aWRlclN0b3JlLnNldCgndHlwZScsIFRZUEUsIHRoaXMpO1xuICB9XG5cbiAgZ2V0IHR5cGUoKTogc3RyaW5nIHtcbiAgICBpZiAodGhpcy5fdHlwZSkgcmV0dXJuIHRoaXMuX3R5cGU7XG4gICAgXG4gICAgdGhpcy5fdHlwZSA9IE9iamVjdC5rZXlzKHRoaXMpLmZpbmQoKGs6IHN0cmluZykgOiBib29sZWFuID0+IGsuc3RhcnRzV2l0aCgndXNlJykgJiYgdGhpc1trXSAhPT0gdW5kZWZpbmVkKTtcbiAgICBcbiAgICByZXR1cm4gdGhpcy5fdHlwZTtcbiAgfVxuICBcbiAgZ2V0IGRlcGVuZGVuY2llcygpOiBzdHJpbmdbXXtcbiAgICByZXR1cm4gdGhpcy5fZGVwZW5kZW5jaWVzO1xuICB9XG59XG5cblxuLy8gIyMgUHJvdmlkZXIgUGFyc2VyXG5Nb2R1bGUuYWRkUHJvdmlkZXIoVFlQRSwgKHByb3ZpZGVyOiBQcm92aWRlciwgbmFtZTogc3RyaW5nLCBpbmplY3RzOiBzdHJpbmdbXSwgbmdNb2R1bGU6IG5nLklNb2R1bGUpID0+IHtcbiAgc3dpdGNoIChwcm92aWRlci50eXBlKSB7XG4gICAgY2FzZSAndXNlVmFsdWUnOlxuICAgICAgICBuZ01vZHVsZS52YWx1ZShwcm92aWRlci50b2tlbiwgcHJvdmlkZXIudXNlVmFsdWUpO1xuICAgICAgICBicmVhaztcbiAgICBjYXNlICd1c2VDb25zdGFudCc6XG4gICAgICAgIG5nTW9kdWxlLmNvbnN0YW50KHByb3ZpZGVyLnRva2VuLCBwcm92aWRlci51c2VDb25zdGFudCk7XG4gICAgICAgIGJyZWFrO1xuICAgIGNhc2UgJ3VzZUNsYXNzJzpcbiAgICAgICAgaW5qZWN0cyA9IGJ1bmRsZVN0b3JlLmdldCgnJGluamVjdCcsIHByb3ZpZGVyLnVzZUNsYXNzKSB8fCBbXTtcbiAgICAgICAgTW9kdWxlLmdldFBhcnNlcihJTkpFQ1RBQkxFKShwcm92aWRlci51c2VDbGFzcywgcHJvdmlkZXIudG9rZW4sIGluamVjdHMsIG5nTW9kdWxlKTtcbiAgICAgICAgYnJlYWs7XG4gICAgY2FzZSAndXNlRmFjdG9yeSc6XG4gICAgICAgIG5nTW9kdWxlLmZhY3RvcnkocHJvdmlkZXIudG9rZW4sIFsuLi5wcm92aWRlci5kZXBlbmRlbmNpZXMsIHByb3ZpZGVyLnVzZUZhY3RvcnldKTtcbiAgICAgICAgYnJlYWs7XG4gICAgZGVmYXVsdDpcbiAgICAgICAgYnJlYWs7XG4gIH1cbn0pO1xuXG5cbi8qKlxuICogU3VnYXIgZm9yIGNyZWF0aW5nIGEgbmV3IGJpbmRpbmcuXG4gKiBAcGFyYW0gdG9rZW5cbiAqL1xuZXhwb3J0IGNvbnN0IHByb3ZpZGUgPSAodG9rZW46IHN0cmluZ3xPcGFxdWVUb2tlbnxGdW5jdGlvbixcbiAgICB7XG4gICAgICB1c2VDbGFzcyxcbiAgICAgIHVzZVZhbHVlLCBcbiAgICAgIHVzZUNvbnN0YW50LCBcbiAgICAgIHVzZUZhY3RvcnksIFxuICAgICAgZGVwc1xuICAgIH0gOiBcbiAgICB7IFxuICAgICAgdXNlQ2xhc3M/OiBhbnksIFxuICAgICAgdXNlVmFsdWU/OiBhbnksIFxuICAgICAgdXNlQ29uc3RhbnQ/OiBhbnksIFxuICAgICAgdXNlRmFjdG9yeT86IGFueSwgXG4gICAgICBkZXBzPzogYW55W11cbiAgICB9XG4gICkgOiBQcm92aWRlciA9PiB7XG4gIHJldHVybiBuZXcgUHJvdmlkZXIodG9rZW4sIHt1c2VDbGFzcywgdXNlVmFsdWUsIHVzZUNvbnN0YW50LCB1c2VGYWN0b3J5LCBkZXBzfSk7XG59OyJdLCJzb3VyY2VSb290IjoiL3NvdXJjZS8ifQ==
